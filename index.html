<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR + Animation RFQ</title>

  <!-- Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/RGBELoader.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; background: #111; overflow: hidden; }

    /* === BANDEAU AR === */
    #ar-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      gap: 20px;
      padding: 0 20px;
      box-sizing: border-box;
    }
    #ar-banner h1 {
      color: white;
      font-size: 16px;
      margin: 0;
    }
    model-viewer {
      width: 120px;
      height: 50px;
      background: transparent;
    }

    /* === CONTENU THREE.JS SOUS LE BANDEAU === */
    #three-container {
      position: absolute;
      top: 60px; /* juste en dessous du bandeau */
      left: 0;
      width: 100%;
      height: calc(100% - 60px);
      overflow: hidden;
    }

    canvas { display: block; }

    #logo-left, #logo-right {
      position: absolute;
      top: 10px;
      width: 100px;
      opacity: 0.9;
      z-index: 10;
      pointer-events: none;
    }
    #logo-left { left: 10px; }
    #logo-right { right: 10px; }

    #explication {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-family: sans-serif;
      font-size: 14px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 8px 16px;
      border-radius: 8px;
      text-align: center;
      max-width: 90%;
      z-index: 10;
      pointer-events: none;
    }

    #viewLabel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-family: sans-serif;
      font-size: 22px;
      font-weight: bold;
      background-color: rgba(0,0,0,0.4);
      padding: 10px 20px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 20;
    }
  </style>
</head>

<body>

  <!-- Bandeau AR -->
  <div id="ar-banner">
    <h1>RFQ in your garden => </h1>
    <model-viewer
      src="dumyRFQ_4webpagetest_centered.glb"
      alt="RFQ Model"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      exposure="1"
      scale="0.001 0.001 0.001"
      shadow-intensity="1"
      shadow-softness="1"
      reveal="interaction"
      autoplay
      style="background: transparent;"
      poster-color="#b87333">
    </model-viewer>
  </div>

  <!-- Conteneur Three.js -->
  <div id="three-container"></div>
  <div id="explication"></div>
  <div id="viewLabel"></div>
  <img id="logo-left" src="LOGO_IRFU_200.png" alt="Logo gauche" />
  <img id="logo-right" src="NewGain_LOGO-1024x259.png" alt="Logo droite" />

  <script>
    const container = document.getElementById("three-container");

    // Charger la description
    fetch('NEWGAIN_description.txt')
      .then(r => r.text())
      .then(data => { document.getElementById('explication').innerText = data; })
      .catch(e => console.error(e));

    // === THREE.JS ===
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 1, 5000*4);
    const pos_Z = 7000;
    camera.position.set(100,100,pos_Z);
    camera.lookAt(0,0,pos_Z);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.outputEncoding = THREE.sRGBEncoding;
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0,0,pos_Z);
    controls.enableZoom = true;
    controls.zoomSpeed = 5;
    controls.minDistance = 0.5;
    controls.maxDistance = 5000*4;
    controls.update();

    // HDRI + modèle
    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    new THREE.RGBELoader()
      .setDataType(THREE.UnsignedByteType)
      .load('https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr', texture => {
        const envMap = pmremGenerator.fromEquirectangular(texture).texture;
        scene.environment = envMap;
        scene.background = new THREE.Color(0x111111);
        texture.dispose();
        pmremGenerator.dispose();

        const gltfLoader = new THREE.GLTFLoader();
        gltfLoader.load('dumyRFQ_4webpagetest.glb', gltf => {
          const mesh = gltf.scene;
          mesh.traverse(c => { if(c.isMesh) c.material = new THREE.MeshStandardMaterial({
            color:0xb87333, metalness:1, roughness:0.2, envMap:scene.environment
          });});
          scene.add(mesh);
        });
      });

    // Lumières
    const nbLights=4,radius=500;
    for(let i=0;i<nbLights;i++){
      const angle=(i/nbLights)*2*Math.PI;
      const dirLight=new THREE.DirectionalLight(0xffffff,0.5);
      dirLight.position.set(radius*Math.cos(angle),300,radius*Math.sin(angle));
      scene.add(dirLight);
    }
    scene.add(new THREE.AmbientLight(0xffffff,1));

    // Particules
    let particleSystem, frames=[], currentFrame=0, lastFrameTime=0;
    const frameInterval = 100;
    async function loadParticles(file){
      const response = await fetch(file);
      const lines = (await response.text()).trim().split("\n");
      frames=[]; let frame=[];
      lines.forEach(line=>{
        if(line.startsWith("#")){
          if(frame.length) frames.push(frame);
          frame=[];
        }else{
          const [x,y,z]=line.split(" ").map(Number);
          frame.push(x,y,z);
        }
      });
      if(frame.length) frames.push(frame);
      createParticles(frames[0]);
    }
    function createParticles(positions){
      if(particleSystem) scene.remove(particleSystem);
      const geo = new THREE.BufferGeometry();
      geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(positions),3));
      const mat = new THREE.PointsMaterial({ color:0xffff00, size:1.5, sizeAttenuation:true, transparent:true });
      particleSystem = new THREE.Points(geo,mat);
      scene.add(particleSystem);
    }
    function updateParticles(time){
      if(!frames.length||!particleSystem) return;
      if(time-lastFrameTime>frameInterval){
        currentFrame=(currentFrame+1)%frames.length;
        particleSystem.geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(frames[currentFrame]),3));
        particleSystem.geometry.attributes.position.needsUpdate=true;
        lastFrameTime=time;
      }
    }

    // Sélecteur de fichier
    const fileSelector = document.createElement("select");
    fileSelector.style.position="absolute";
    fileSelector.style.top="70px"; // sous le bandeau AR
    fileSelector.style.left="10px";
    fileSelector.innerHTML=`
      <option value="particles_NG_1.txt">Positions 1</option>
      <option value="positions2.txt">Positions 2</option>
      <option value="positions3.txt">Positions 3</option>
    `;
    document.body.appendChild(fileSelector);
    fileSelector.addEventListener("change",()=>loadParticles(fileSelector.value));
    loadParticles(fileSelector.value);

    // Vues caméra
    const cameraViews=[
      {pos:new THREE.Vector3(3*300,3*100,7000),target:new THREE.Vector3(10,20,7000)},
      {pos:new THREE.Vector3(-50*2,-50*2,0),target:new THREE.Vector3(10,20,7000)},
      {pos:new THREE.Vector3(100*3,100*3,0),target:new THREE.Vector3(10,20,0)},
      {pos:new THREE.Vector3(200*1,300*1,1000),target:new THREE.Vector3(10,20,1000)},
      {pos:new THREE.Vector3(100,100,7000),target:new THREE.Vector3(10,20,2000)}
    ];
    let currentView=0,transitioning=false,transitionStart=0,transitionDuration=12000;
    const startPos=new THREE.Vector3(), startTarget=new THREE.Vector3();
    const viewLabel=document.getElementById("viewLabel");

    function nextCameraView(){
      if(transitioning) return;
      currentView=(currentView+1)%cameraViews.length;
      startPos.copy(camera.position);
      startTarget.copy(controls.target);
      transitionStart=performance.now();
      transitioning=true;
      viewLabel.innerText=`Vue ${currentView+1}`;
      viewLabel.style.opacity=1;
      setTimeout(()=>viewLabel.style.opacity=0,1000);
    }

    const viewComments=[
      "The bunched and accelerated beam is finally extracted at the end of the cavity and ready to be injected into the HEBT",
      "The ESS RFQ is 4.5m long, manufacturing errors are corrected inserting 60 slug tuners evenly distributed along the cavity.",
      "A laminar low energy beam coming from the LEBT is injected at the input of the cavity",
      "Then the beam is focused all along the cavity and progressively bunched",
      "After about 2 meters, the beam is bunched and starts to accelerate"
    ];

    window.addEventListener("keydown",(e)=>{
      if(e.code==="Space"){
        e.preventDefault();
        nextCameraView();
      }
    });

    renderer.domElement.addEventListener("touchend",(e)=>{
      const now=performance.now(),delta=now-(window.lastTap||0);
      if(delta>0&&delta<300){ e.preventDefault(); nextCameraView(); }
      window.lastTap=now;
    },{passive:false});

    function animate(time=0){
      requestAnimationFrame(animate);
      updateParticles(time);
      if(transitioning){
        const t=Math.min((time-transitionStart)/transitionDuration,1);
        const ease=t*t*(3-2*t);
        const target=cameraViews[currentView];
        camera.position.lerpVectors(startPos,target.pos,ease);
        controls.target.lerpVectors(startTarget,target.target,ease);
        if(t>=1) transitioning=false;
      }
      controls.update();
      renderer.render(scene,camera);
    }
    animate();

    window.addEventListener("resize",()=>{
      renderer.setSize(container.clientWidth,container.clientHeight);
      camera.aspect=container.clientWidth/container.clientHeight;
      camera.updateProjectionMatrix();
    });

  </script>
</body>
</html>
